# name: test/extension/autoloading_base.test
# description: Base tests for the autoloading mechanism for extensions
# group: [extension]

# TODO: this currently also means autoloading is enabled, should be separate those?
# TODO: this also requires having the JSON AND ICU extensions NOT loaded
require-env LOCAL_EXTENSION_REPO

# Default is expected to be true when running this test
query I
select value from duckdb_settings() where name='autoload_known_extensions';
----
true

# Ensure we have a clean extension directory without any preinstalled extensions
statement ok
set extension_directory='__TEST_DIR__/autoloading_base'

### No autoloading: throw error with installation hint
statement ok
set autoload_known_extensions=false

statement error
SET timezone='UTC';
----
Catalog Error: Setting with name "timezone" is not in the catalog, but it exists in the icu extension.

statement error
select * from read_json_auto('data/json/example_n.ndjson');
----
Catalog Error: Function with name "read_json_auto" is not in the catalog, but it exists in the json extension.

statement error
select * from thistablefunctionwillnotexistfosho();
----
Catalog Error: Table Function with name thistablefunctionwillnotexistfosho does not exist!

### Autoloading, but the autoloading repository is set to non-existent location
statement ok
set autoload_known_extensions=true

# Override the default repo with a non-existent dir
statement ok
set autoload_extension_repository='/tmp/non-existent-repo';

# Error should inform the user on whats happening
statement error
SET timezone='UTC';
----
IO Error: Attempted to automatically install the 'icu' extension, but the following error occured: (Failed to copy local extension "icu" at PATH

statement error
select * from read_json_auto('data/json/example_n.ndjson');
----
IO Error: Attempted to automatically install the 'json' extension, but the following error occured: (Failed to copy local extension "json" at PATH

statement error
select * from thistablefunctionwillnotexistfosho();
----
Catalog Error: Table Function with name thistablefunctionwillnotexistfosho does not exist!

### Autoloading with correct tmp repo
statement ok
set autoload_extension_repository='${LOCAL_EXTENSION_REPO}';

statement ok
SET timezone='UTC';

statement ok
select * from read_json_auto('data/json/example_n.ndjson');